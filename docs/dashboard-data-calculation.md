# Dashboard Data Calculation

## Overview

**ALL data on the dashboard is dynamically generated from real database queries.** There are NO hardcoded placeholders. Every number, insight, and activity item is calculated in real-time from your actual data.

---

## 1. Overview Stats (Right Sidebar)

### Total Customers
```typescript
// Query: convex/dashboard.ts - getOverviewStats
const customers = await ctx.db
  .query("customers")
  .withIndex("by_user", (q) => q.eq("userId", args.userId))
  .collect();

const totalCustomers = customers.length;
```

**Calculation**: Simple count of all customer records for the user.

**Example**: If you have 1,000 customers in the database → displays "1,000"

---

### Total Revenue
```typescript
const totalRevenue = customers.reduce((sum, c) => sum + c.totalSpent, 0);
return Math.round(totalRevenue * 100) / 100;
```

**Calculation**: 
1. Sum all `totalSpent` values from all customers
2. Round to 2 decimal places

**Example**: 
- Customer 1: $450.50
- Customer 2: $320.00
- Customer 3: $180.25
- **Total**: $950.75

---

### Active Campaigns
```typescript
const activeCampaigns = await ctx.db
  .query("campaigns")
  .withIndex("by_user", (q) => q.eq("userId", args.userId))
  .filter((q) => q.neq(q.field("status"), "draft"))
  .collect();

return activeCampaigns.length;
```

**Calculation**: Count campaigns where `status != "draft"`

**Includes**: "scheduled", "sending", "sent", "paused"  
**Excludes**: "draft"

**Example**: If you have 2 sent campaigns + 1 scheduled → displays "3"

---

### Running Flows
```typescript
const activeFlows = await ctx.db
  .query("flows")
  .withIndex("by_status", (q) => q.eq("status", "active"))
  .filter((q) => q.eq(q.field("userId"), args.userId))
  .collect();

return activeFlows.length;
```

**Calculation**: Count flows where `status = "active"`

**Example**: If you have 2 active flows → displays "2"

---

## 2. AI Discovered Insights

### Insight 1: Best Send Day

**Data Source**: `campaignPerformance` table (generated by seed script)

```typescript
// Step 1: Get all campaign performance records
const campaignPerformance = await ctx.db
  .query("campaignPerformance")
  .withIndex("by_user", (q) => q.eq("userId", args.userId))
  .collect();

// Step 2: Group by day of week and calculate averages
const dayStats = {};
campaignPerformance.forEach((cp) => {
  if (!dayStats[cp.dayOfWeek]) {
    dayStats[cp.dayOfWeek] = { revenue: 0, count: 0 };
  }
  dayStats[cp.dayOfWeek].revenue += cp.revenue;
  dayStats[cp.dayOfWeek].count += 1;
});

// Step 3: Find day with highest average revenue
let bestDay = "";
let bestAvgRevenue = 0;
Object.entries(dayStats).forEach(([day, stats]) => {
  const avg = stats.revenue / stats.count;
  if (avg > bestAvgRevenue) {
    bestAvgRevenue = avg;
    bestDay = day;
  }
});
```

**Calculation**:
1. Query all campaign performance records (25 records from seed data)
2. Group by `dayOfWeek` (Monday, Tuesday, etc.)
3. Calculate average revenue per day: `totalRevenue / campaignCount`
4. Find the day with highest average

**Example**:
- **Tuesday**: 8 campaigns, $7,360 total → **$920 average**
- **Friday**: 12 campaigns, $3,720 total → $310 average
- **Result**: "Thursday sends perform best - Campaigns sent on Thursday generate $920 average revenue"

**Condition**: Only shows if you have 5+ campaign performance records

---

### Insight 2: At-Risk Customers

**Data Source**: `customers` table

```typescript
const atRiskCustomers = await ctx.db
  .query("customers")
  .withIndex("by_churn_risk", (q) => q.eq("churnRisk", "High"))
  .filter((q) => q.eq(q.field("userId"), args.userId))
  .collect();

if (atRiskCustomers.length > 0) {
  insights.push({
    type: "segment_opportunity",
    priority: "medium",
    title: `${atRiskCustomers.length} at-risk customers detected`,
    description: "High-value customers who haven't ordered recently",
    action: "Create win-back campaign",
  });
}
```

**Calculation**:
1. Query customers where `churnRisk = "High"`
2. Count the results

**Churn Risk Logic** (from seed script):
```typescript
function getChurnRisk(days: number | undefined, orders: number): string {
  if (!days) return "Low";
  if (days > 90 && orders > 5) return "High";  // ← This creates at-risk customers
  if (days > 45 && orders > 2) return "Medium";
  return "Low";
}
```

**Example**:
- Customer has 10 orders (high-value)
- Last order was 120 days ago
- **Result**: `churnRisk = "High"`
- If 299 customers match this → displays "299 at-risk customers detected"

---

## 3. Recent Activity

### Activity Sources

**1. Recent Segments**
```typescript
const recentSegments = await ctx.db
  .query("segments")
  .withIndex("by_user", (q) => q.eq("userId", args.userId))
  .order("desc")  // ← Sorted by creation date (newest first)
  .take(2);       // ← Get 2 most recent
```

**Displays**:
- Title: "Segment created" or "AI created segment" (if `aiGenerated = true`)
- Description: Segment name in quotes
- Timestamp: `createdAt` field

---

**2. Recent Campaigns**
```typescript
const recentCampaigns = await ctx.db
  .query("campaigns")
  .withIndex("by_user", (q) => q.eq("userId", args.userId))
  .order("desc")
  .take(2);

// Only show if status = "sent"
if (campaign.status === "sent") {
  activities.push({
    title: "Campaign sent",
    description: `"${campaign.name}" • ${campaign.sentCount || 0} emails`,
    timestamp: campaign.sentAt || campaign.createdAt,
  });
}
```

**Displays**:
- Title: "Campaign sent"
- Description: Campaign name + email count
- Timestamp: `sentAt` (or `createdAt` as fallback)

---

**3. Recent Flows**
```typescript
const recentFlows = await ctx.db
  .query("flows")
  .withIndex("by_user", (q) => q.eq("userId", args.userId))
  .order("desc")
  .take(1);

// Only show if status = "active"
if (flow.status === "active") {
  activities.push({
    title: "Flow activated",
    description: `"${flow.name}"`,
    timestamp: flow.createdAt,
  });
}
```

**Displays**:
- Title: "Flow activated"
- Description: Flow name in quotes
- Timestamp: `createdAt`

---

### Activity Sorting

```typescript
// Combine all activities and sort by timestamp (newest first)
activities.sort((a, b) => 
  new Date(b.timestamp).getTime() - new Date(a.timestamp).getTime()
);

return activities.slice(0, 5); // Return top 5 most recent
```

**Result**: Shows up to 5 most recent activities across all types, sorted by time.

---

## 4. Timestamp Formatting

```typescript
// In dashboard page.js
const formatTimestamp = (timestamp) => {
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 60) return `${diffMins}m ago`;
  if (diffHours < 24) return `${diffHours}h ago`;
  return `${diffDays}d ago`;
};
```

**Examples**:
- Created 30 minutes ago → "30m ago"
- Created 4 hours ago → "4h ago"
- Created 16 days ago → "16d ago"

---

## Summary: Is This Real Data?

### ✅ YES - 100% Real, Dynamically Calculated

| Dashboard Element | Data Source | Calculation Method |
|-------------------|-------------|-------------------|
| Total Customers | `customers` table | Count all records |
| Total Revenue | `customers.totalSpent` | Sum all values |
| Active Campaigns | `campaigns` table | Count where status != "draft" |
| Running Flows | `flows` table | Count where status = "active" |
| Best Send Day | `campaignPerformance` table | Group by day, calculate averages |
| At-Risk Customers | `customers.churnRisk` | Count where churnRisk = "High" |
| Recent Activity | `segments`, `campaigns`, `flows` | Query latest records, sort by time |

### ❌ NO Placeholders

- No hardcoded numbers
- No fake data in the dashboard code
- All calculations happen in real-time
- Data updates automatically when database changes

---

## How Seed Data Creates This

The seed script (`convex/seed.ts`) generates:

1. **1,000 customers** with realistic:
   - Purchase history → creates `totalSpent` values
   - Churn risk calculations → creates at-risk customers
   - Creation dates → enables activity timeline

2. **5 segments** → appear in recent activity

3. **4 campaigns** with fake performance → enables insights

4. **25 campaign performance records** → enables "best day" analysis

5. **2 flows** → appear in recent activity

**Result**: Dashboard shows real patterns from this generated data, not placeholders.

---

## Verification

To verify this is real data:

1. **Check Convex Dashboard**: View your actual database records
2. **Count customers**: Should match dashboard number exactly
3. **Sum revenue**: Calculate manually from customer records
4. **Check timestamps**: Activity items match actual creation dates

**Everything is connected to real database queries.**

---

**Last Updated**: November 19, 2024  
**Version**: 1.0
